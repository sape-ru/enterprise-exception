# CustomizableException

**CustomizableException** позволяет решить множество проблем (этот класс назван _customizable_, т. е. _настраиваемым_
не просто так). Одна из возможных проблем и её решение описаны в этой статье для иллюстрации встроенного
функционала. Обратитесь к [разделу _для опытных_](../experienced/customizable-exception.md) за инструкциями по тонкой
настройке.

**CustomizableException** наследует **GlobalException**. Однако вам не нужно изучать сейчас
[документацию](global-exception.md) **GlobalException** - соответствующие настройки являются необязательными, и вы
можете полностью пропустить их, если хотите использовать лишь функционал **CustomizableException**.

Содержание:
- [Проблема](#проблема)
- [Решение](#решение)
- [Как это работает](#как-это-работает)
    - [Если вы обновляете ваши старые исключения](#если-вы-обновляете-ваши-старые-исключения)
- [Настройка](#настройка)
    - [Пользовательская версия сообщения для конкретного исключения
    ](#пользовательская-версия-сообщения-для-конкретного-исключения)
    - [Контекст исключения](#контекст-исключения)
    - [Демонстрационный скрипт](#демонстрационный-скрипт)

## Проблема

Представьте, что у вашего приложения есть две группы исключений:
1. Исключения, которые вы можете показывать пользователям. Пользователи прочитывают сообщения из этих исключений,
понимают (как вы надеетесь) свои ошибки или обстоятельства и реагируют соответствующим образом.
1. Исключения, которые описывают низкоуровневую логику либо конфиденциальные детали, и вы не хотите, чтобы это увидели
пользователи. Вы предпочёте записывать сообщения от таких исключений в ваши скрытые логи, таблицу в базе данных либо
иное хранилище. Также вы бы хотели всё-таки позволять пользователям как-то уведомлять вас о возникновении подобных
исключений, но без раскрытия их настоящих описаний.

## Решение

Было бы здорово задать конфиг, который управлял бы, сообщения каких исключений можно показывать пользователям, а для
каких исключений их сообщения нужно заменить какими-нибудь публичным общим описанием. Заменой может стать просто код
исключения и/или ссылка на страницу технической поддержки вашего приложения.

## Как это работает

**CustomizableException** позволяет вам задавать флаг, контролирующий, можно ли показывать пользователям настоящее
сообщение об исключении. Данный флаг является лишь одним из возможных свойств исключений. Но как именно мы привязываем
свойства к конкретным исключениям?

**CustomizableException** обеспечивает связь исключений и их свойств с помощью кодов исключений (_базовых кодов_, если
речь идёт об исключениях [GlobalException](global-exception.md#как-это-работает)) в качестве уникальных ключей для
элементов с массивами свойств. Таким образом, код исключения становится обязательным. Более того, код исключения
становится _первым_ параметром конструктора. Это главное отличие между сигнатурами
`CustomizableException::__construct()` и классического `Exception::__construct()`.

Сообщение исключения становится одним из свойств (и далее называется _base message_, т. е. _базовым сообщением_), так
что вы больше не передаёте это сообщение в конструктор. Вместо этого вы можете передать _детали_ (_details_)
исключения - необязательную подстроку с данными, определёнными во время выполнения, о которых вы считаете полезным
сообщить; они добавляются к неизменному _базовому сообщению_:

```php
$e = new UserException(1, 'осталось 2 попытки'); // содержит свойство с базовым сообщением: "Неверный пароль"
echo $e->getMessage(); // >> 'Неверный пароль (осталось 2 попытки)'
```

### Если вы обновляете ваши старые исключения

К примеру, у вашего приложение уже есть куча классов исключений, которые наследуются от некоторого базового класса
исключений, и вы не хотите исправлять разом все ваши исключения, чтобы они соответствовали требованиям конструктора
**CustomizableException**. Вероятно, вы захотите адаптировать ваши классы исключений по одному...

Не беспокойтесь! Вы можете сразу же позволить вашему базовому классу исключений наследовать **CustomizableException**
без каких-либо проблем в последствии - **CustomizableException** предоставляет вам двухрежимный конструктор. Если вы
передадите этому конструктору нечисловое значение в качестве первого аргумента, конструктор будет работать так же, как
и классический конструктор `Exception` (или [GlobalException](global-exception.md)). И только если в качестве первого
аргумента будет задано числовое значение, это значение будет рассматриваться как (_базовый_) код исключения, второй
аргумент будет считаться _деталями_ исключений, а также будут применены свойства этого исключения (если заданы):

```php
// режим настраиваемого исключения
$e = new UserException(1, 'осталось 2 попытки'); // содержит свойство с базовым сообщением: "Неверный пароль"
echo $e->getMessage(); // >> 'Неверный пароль (осталось 2 попытки)'

// классический режим
$e = new UserException('осталось 2 попытки', 1);
echo $e->getMessage(); // >> 'осталось 2 попытки'
```

## Настройка

Предположим, у вас есть класс исключений `UserException`. У вас есть исключение, сообщение которого вы можете вывести
пользователю - "_Недостаточно средств_" (**12**).  Также у вас есть другое исключение "_Операция недоступна для
ненадёжных пользователей_" (**301**), и вы не хотите, чтобы пользователи увидели его настоящее сообщение.

1. Заставьте `UserException` наследовать **CustomizableException**.
1. Задайте свойства исключений в массиве `EXCEPTIONS_PROPERTIES`:

    ```php
    use MagicPush\EnterpriseException\CustomizableException\CustomizableException;
    
    class UserException extends CustomizableException
    {
        const NOT_ENOUGH_MONEY     = 12;
        const FORBIDDEN_UNRELIABLE = 301;
    
        const EXCEPTIONS_PROPERTIES = [ // это центральный конфиг для настройки всех ваших исключений
            self::NOT_ENOUGH_MONEY     => [
                'message' => 'Недостаточно средств', // базовое сообщение
                // флаг ниже определяет, может ли пользователь видеть настоящее сообщение
                'show_fe' => true, // "FE" означает "Front End";
            ],
            self::FORBIDDEN_UNRELIABLE => [
                'message' => 'Операция недоступна для ненадёжных пользователей',
                'show_fe' => false, // можно не указывать, т. к. это - поведение по умолчанию
            ],
        ];
    }
    ```

1. Выбрасывайте исключения с соответствующими кодами; добавляйте _детали_ по необходимости:

    ```php
    class BillingService
    {
        // ...
    
        public function checkWallet()
        {
            // ...
            
            if ($this->price > $this->user->money_available) {
                throw new UserException(
                    UserException::NOT_ENOUGH_MONEY,
                    'вам нужно внести $' . ($this->price - $this->user->money_available)
                );
            }
            if ($this->user->is_unreliable) {
                throw new UserException(UserException::FORBIDDEN_UNRELIABLE);
            }
        }
    ```

1. Обрабатывайте исключения:

    ```php
    try {
        // ...
        
        $billing_service->checkWallet();
    } catch (CustomizableException $e) {
        $error_message = $e->getMessageFe(); // выводите только те сообщения, которые может видеть пользователь
        // NOT_ENOUGH_MONEY >> 'Недостаточно средств (вам нужно внести $3.05)'
        // FORBIDDEN_UNRELIABLE >> 'error 301'
    } finally {
        error_log($e->getMessage()); // or $e->__toString(); логируйте настоящие сообщения
        // NOT_ENOUGH_MONEY >> 'Недостаточно средств (вам нужно внести $3.05)'
        // FORBIDDEN_UNRELIABLE >> 'Операция недоступна для ненадёжных пользователей'
    }
    ```

Метод `getMessageFe()` проверяет, равняется ли **true** свойству исключения '_show\_fe_' (а фактически, значению,
возвращаемому `canShowFe()`). Если равняется, то выводится то же самое сообщение, которое возвращает `getMessage()`.
Иначе выводится заглушка "_error XXX_" где _XXX_ - код исключения (который также может быть _глобальным кодом_, если
вы примените функционал [GlobalException](global-exception.md#настройка)). Если вы желаете переопределить эту строку
FE-заглушки по умолчанию, вам стоит изучить этот вопрос в
[разделе _для опытных_](../experienced/customizable-exception.md#заглушка-для-пользовательского-сообщения).

Также **CustomizableException** предоставляет вам обёртку для переводов `getL10N()`. Загляните в
[раздел _для опытных_](../experienced/customizable-exception.md#обёртка-для-переводов) за подобробной информацией по
данному вопросу и другим тонкостям.

### Пользовательская версия сообщения для конкретного исключения

Возможно, вам захочется заменить пользовательскую версию сообщения для исключения `FORBIDDEN_UNRELIABLE` на что-то
более конкретное - альтернативную версию, безопасную для вывода пользователям. Задайте свойство '_message\_fe_' и
включите флаг '_show\_fe_':

```php
// ...

class UserException extends CustomizableException
{
    // ...

    const EXCEPTIONS_PROPERTIES = [
        // ...
        self::FORBIDDEN_UNRELIABLE => [
            'message'    => 'Операция недоступна для ненадёжных пользователей',
            // ниже задана пользовательская версия сообщения только для данного исключения
            'message_fe' => 'Пожалуйста, сначала подтвердите ваш электронный адрес',
            'show_fe'    => true, // требуется включить этот флаг, чтобы использовать свойство 'message_fe'
        ],
        // ...
    ];
}

// =======================

// ... где-то в вашем пользовательском интерфейсе
try {
    // ...
    
    $billing_service->checkWallet();
} catch (CustomizableException $e) {
    $error_message = $e->getMessageFe(); // >> 'Пожалуйста, сначала подтвердите ваш электронный адрес'
} finally {
    error_log($e->getMessage()); // or $e->__toString(); >> 'Операция недоступна для ненадёжных пользователей'
}
```

### Контекст исключения

Иногда вам хочется добавить к сообщению исключения подстроку, описывающую обстоятельства, при которых было брошено
исключение. К примеру, у вас есть два исключения "недостаточно средств" со схожими сообщениями в вашем платёжном
сервисе. Однако одно исключение возникает, если пользователь хочет активировать "pro"-версию своего профиля. Другое же
возникает в случае, когда пользователь пытается купить для профиля новый скин (я знаю, вы любите такие штуки,
предприимчивые вы люди ;) ).

Вы можете просто создать два разных исключения с разными же сообщениями. А можете вместо этого создать лишь одно
исключение, а затем задавать ему тот или иной контекст с помощью `setContext()` в зависимости от обстоятельств:

```php
// активация "pro"-версии профила...
} catch (CustomizableException $e) {
    $e->setContext('Обновление вашего профиля');
    $error_message = $e->getMessageFe();
    // >> 'Обновление вашего профиля: Недостаточно средств (вам нужно внести $3.05)'
}

// покупка скина для профиля...
} catch (CustomizableException $e) {
    // $skin_name = 'CoolLook';
    $e->setContext(srpintf('Покупка скина "%s"', $skin_name));
    $error_message = $e->getMessageFe();
    // >> 'Покупка скина "CoolLook": Недостаточно средств (вам нужно внести $3.05)'
}
```

Но это ещё не всё! Вы даже можете задать контекст _по умолчанию_ (свойство '_context_') и переопределять его во время
выполнения (вызывая `setContext()`) только при необходимости!

```php
// ...

class UserException extends CustomizableException
{
    // ...

    const EXCEPTIONS_PROPERTIES = [
        // ...
        self::NOT_ENOUGH_MONEY     => [
            'context' => 'Невозможно купить услугу', // контекст по умолчанию
            'message' => 'Недостаточно средств',
            'show_fe' => true,
        ],
        // ...
    ];
}

// покупая что-либо...
} catch (CustomizableException $e) {
    $error_message = $e->getMessageFe();
    // >> 'Невозможно купить услугу: Недостаточно средств (вам нужно внести $3.05)'
    $e->setContext('Обновление профиля');
    $error_message = $e->getMessageFe(); // >> 'Обновление профиля: Недостаточно средств (вам нужно внести $3.05)'
}
```

### Демонстрационный скрипт

В репозитории есть демонстрационный скрипт с несколькими уже настроенными классами и свойствами их исключений для
быстрого ознакомления с поддерживаемыми свойствами. Просто запустите его в командной строке:

```php
php examples/customizable.php
```

## Читайте также

- [GlobalException](global-exception.md)
- [Parser](parser.md)
- [Углублённое изучение CustomizableException](../experienced/customizable-exception.md)
