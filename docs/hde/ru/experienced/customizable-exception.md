# Углублённое изучение CustomizableException

Данная статья посвящена тонкой настройке [CustomizableException](../dummies/customizable-exception.md). Если вы ещё не
знакомы с основным функционалом библиотеки, [изучите его](../dummies/about.md) в первую очередь!

Не забывайте о главной особенности **CustomizableException** - _настраиваемости_: вдобавок к уже
поддерживаемым свойствам вы можете расширить `EXCEPTIONS_PROPERTIES`, дополнив любым количеством своих собственных
свойств!

Содержание:
- [Составление полного сообщения](#составление-полного-сообщения)
- [Заглушка для пользовательского сообщения](#заглушка-для-пользовательского-сообщения)
- [Обёртка для переводов](#обёртка-для-переводов)
- [Базовое сообщение по умолчанию](#базовое-сообщение-по-умолчанию)
- [Неизвестное исключение](#неизвестное-исключение)

## Составление полного сообщения

Классическое сообщение исключения - это просто строка, которую вы передаёте конструктору в качестве первого аргумента.
_Полное сообщение_ исключения [CustomizableException](../dummies/customizable-exception.md) составляется с помощью
`getMessageComposed()` из нескольких частей (таких как _конекст_, _базовое сообщение_ и _детали_). Данный метод неявно
вызывается:
- в конструкторе для составления [_системной_ версии](#обёртка-для-переводов);
- в `getMessageFe()` для составления [_пользовательской_ версии](#обёртка-для-переводов) (если исключение настроено
как FE-видимое);
- в [Parser](../dummies/parser.md#возвращаемые-данные) при формировании возвращаемых данных (если
`$options['is_extended']` равняется **false**).

Изначально данный метод составляет _полное сообщение_ в формате:
`[контекст, если задан: ]базовое сообщение[ (детали, если заданы)]`:

```php
class UserException extends CustomizableException
{
    const EXCEPTIONS_PROPERTIES = [
        12 => [
            'message' => 'Недостаточно средств',
        ],
    ];
}

$e = new UserException(12);
echo $e->getMessage(); // >> Недостаточно средств

$e = new UserException(12, 'вам нужно внести $3.05');
$e->setContext('Обновление вашего профиля');
echo $e->getMessage(); // >> Обновление вашего профиля: Недостаточно средств (вам нужно внести $3.05)
```

Переопределите `getMessageComposed()`, если хотите изменить формат _полного сообщения_ или добавить к нему новые части.

## Заглушка для пользовательского сообщения

Когда вы вызываете `getMessageFe()`, данный метод проверяет, возвращает ли `canShowFe()` значение `true`. Если это так,
`getMessageFe()` составляет и возвращает [_пользовательскую_ версию](#обёртка-для-переводов) _полного сообщения_. Иначе
возвращается значение `getMessageFeStub()`. Это может быть полезно, когда вы не хотите показывать пользователю
настоящую причину, но хотите сообщить некоторую основную информацию вроде кода исключения.

Изначально `getMessageFeStub()` возвращает строку "_error XXX_", где _XXX_ -
[форматированный код](global-exception.md#форматирование-глобальных-кодов) исключения. Однако вы можете переопределить
данный метод, чтобы возвращать адрес почты или страницу для связи со службой поддержки, либо что-нибудь иное, что вы
посчитаете возможным и полезным сообщить пользователям.

## Обёртка для переводов

Статьи об основах использования [CustomizableException](../dummies/customizable-exception.md#настройка) и
[Parser](../dummies/parser.md#возвращаемые-данные) упоминают обёртку для переводов `getL10N()`. Изначально данный
публичный статический метод просто возвращает свой первый аргумент как есть (предполагая, что этот аргумент является
строкой). Но вы можете переопределить метод, включив в него обработку переводов, которую использует ваше приложение.

У данного метода есть два параметра. Первый - строка для перевода либо аргумент любого другого типа, который вам нужно
передавать в вашу функцию перевода. Второй - локаль перевода. В качестве локали вы можете задать не только строку
с именем локали, но также `false` или `null`:
- Значение `false` должно рассматриваться как отсутствие всякого перевода. Это бывает полезно, если вы хотите быть
уверены, что та или иная строка, пропущенная через обёртку, останется неизменной. Иногда вы не можете контролировать
ситуации, в которых вызывается обёртка для переводов, так что `false` как раз спасает вас в таких случаях.
- Значение `null` должно рассматриваться как локаль, определённая автоматически. К примеру, это может быть локаль
текущего пользователя, сохранённая в его сессии. Это бывает полезно, когда вы хотите вывести соообщение пользователю,
но вам не нужно явно определять и задавать локаль этого пользователя.

### Системная локаль

**CustomizableException** предоставляет константу `L10N_SYSTEM_LOCALE`. Эта константа используется преимущественно
для неявных переводов частей сообщений исключений в их _системные_ версии.

По умолчанию данной константе присвоено значение '_en_'. Но вы можете переопределить её, задав любое значение, которое
поддерживает `getL10N()` в качестве значения `$locale`.

### Применение

Вы можете вызывать эту обрётку вручную, если хотите. Однако для вашего удобства она неявно вызывается:
- когда вы [меняете контекст исключения](../dummies/customizable-exception.md#контекст-исключения) (задана `$locale`
со значением `null`) во время выполнения;
- в `getMessageFeStub()` (задана `$locale` со значением `null`) для подстроки '_error_', если вы не
[переопределили метод](#заглушка-для-пользовательского-сообщения)
- в [Parser](../dummies/parser.md#возвращаемые-данные) (задана `$locale` со значением `$options['locale']`) для частей
сообщений исключений во время формирования возвращаемых данных - вы можете задать любую локаль в настройке '_locale_'
(по умолчанию её значение равно `L10N_SYSTEM_LOCALE`).

Конструктор вызывает `getL10N` дважды - для _системной_ и _пользовательской_ версий _контекста_, _базового сообщения_
и _деталей_ исключения:
1. _Системная_ версия создаётся за счёт передачи `L10N_SYSTEM_LOCALE` в качестве значения `$locale`. Затем
[составленное сообщение](#составление-полного-сообщения) передаётся в родительский конструктор, благодаря чему вы
можете получить это сообщение для записи в лог или вывода в админке.
1. _Пользовательская_ версия создаётся за счёт передачи `null` в качестве значения `$locale`. Затем _контекст_,
_базовое сообщение_ и _детали_ становятся доступны по-отдельности благодаря методам `getContext()`, `getMessageBase()`
и `getDetails()` соответственно; также эти части используются для
[составления _полного сообщения_](#составление-полного-сообщения) в `getMessageFe()`
(если исключение настроено как видимое в пользовательском интерфейсе).

## Базовое сообщение по умолчанию

Если среди свойств исключения не обнаружено свойство '_message_', конструктор считает такое исключение скрытым от
пользователей (`canSowFe()` возвращает `false`) и в качестве _базового сообщения_ исключения устанавливает значение,
возвращаемое методом `getMessageDefault()`.

Изначально такое сообщение имеет следующий формат: `CustomizableException XXX (YYY::ZZZ)`, где _XXX_ -
[форматированный код](global-exception.md#форматирование-глобальных-кодов) исключения, _YYY_ - полное имя класса
исключения, а _ZZZ_ - код исключения (_базовый код_, если вы используете функционал
[GlobalException](../dummies/global-exception.md#как-это-работает)).

Переопределите `getMessageDefault()`, как вам больше нравится, чтобы это сообщение лучше соответствовало требованиям
к сообщениям в ваших логах или админке.

## Неизвестное исключение

Если в `EXCEPTIONS_PROPERTIES` нет элемента со свойствами, соответствующего брошенному исключению, конструктор считает
такое исключение скрытым от пользователей (`canSowFe()` возвращает `false`) и в качестве _базового сообщения_
исключения устанавливает значение, возвращаемое методом `getMessageUnknown()`.

Изначально такое сообщение имеет следующий формат: `unknown base code XXX for CustomizableException (YYY)`, где _XXX_ -
код исключения (_базовый код_, если вы используете функционал
[GlobalException](../dummies/global-exception.md#как-это-работает)), а _YYY_ - полное имя класса исключения.

Переопределите `getMessageUnknown()`, как вам больше нравится, чтобы это сообщение лучше соответствовало требованиям
к сообщениям в ваших логах или админке.

## Читайте также

- [Углублённое изучение GlobalException](global-exception.md)
- [Углублённое изучение Parser](parser.md)
- [Основы CustomizableException](../dummies/customizable-exception.md)
